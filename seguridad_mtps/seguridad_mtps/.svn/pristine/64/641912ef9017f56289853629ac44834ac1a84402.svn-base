<?php

define('BITACORA',202);
define('BASE_DATOS',203);


class Seguridad extends CI_Controller
{
    
    function Seguridad()
	{
        parent::__construct();
		date_default_timezone_set('America/El_Salvador');
		$this->load->model('usuario_model');
		$this->load->model('seguridad_model');
		$this->load->model('transporte_model');
		$this->load->library("mpdf");
    	if(!$this->session->userdata('id_usuario')) {
			redirect('index.php/sessiones');
		}
    }
	
	function index()
	{
		$this->bitacora();
  	}

	/*
	*	Nombre: bitacora
	*	Objetivo: Carga la vista para la administración de la bitacora
	*	Hecha por: Oscar
	*	Modificada por: Oscar
	*	Última Modificación: 19/06/2015
	*	Observaciones: Ninguna.
	*/
	
	function bitacora($estado_transaccion=NULL, $tipo=NULL)
	{
		$data=$this->seguridad_model->consultar_permiso($this->session->userdata('id_usuario'),BITACORA);
		
		if($data['id_permiso']==3)
		{
			$data['bitacora']=$this->seguridad_model->bitacora_reg();
			
			if($tipo!=NULL && $estado_transaccion!=NULL)
			{
				$msj="";
				switch($tipo)
				{
					case 1: $msj="El registro ha sido modificado con éxito"; break;
					case 2: $msj="El registro ha sido eliminado con éxito"; break;
				}
				
				$data['estado_transaccion']=$estado_transaccion;
				$data['msj']=$msj;
			}
			
			pantalla('seguridad/bitacora',$data);
			
		}
		else
		{
			echo "No tiene permiso para acceder";
		}
	}
	
	/*
	*	Nombre: ventana_bitacora
	*	Objetivo: Carga la ventana de la inforamción del registro de bitácora
	*	Hecha por: Oscar
	*	Modificada por: Oscar
	*	Última Modificación: 19/06/2015
	*	Observaciones: Ninguna.
	*/
	
	function ventana_bitacora($id_bitacora)
	{
		$data=$this->seguridad_model->consultar_permiso($this->session->userdata('id_usuario'),BITACORA);
		
		if($data['id_permiso']==3)
		{
			$data['bitacora']=$this->seguridad_model->bitacora_reg($id_bitacora);
			$data['bitacora']=$data['bitacora'][0];
			$this->load->view('seguridad/ventana_bitacora',$data);
		}
		else
		{
			echo "No tiene permiso para acceder";
		}
	}
	
	/*
	*	Nombre: eliminar_bitacora
	*	Objetivo: Elimina el registro de la bitacora
	*	Hecha por: Oscar
	*	Modificada por: Oscar
	*	Última Modificación: 19/06/2015
	*	Observaciones: Ninguna.
	*/
	
	function eliminar_bitacora($id_bitacora)
	{
		$data=$this->seguridad_model->consultar_permiso($this->session->userdata('id_usuario'),BITACORA);
		
		if($data['id_permiso']==3)
		{
			$this->db->trans_start();
			$this->seguridad_model->eliminar_bitacora($id_bitacora);
			$this->db->trans_complete();
			$tr=($this->db->trans_status()===FALSE)?0:1;
			redirect('index.php/seguridad/bitacora/'.$tr.'/2');
		}
		else
		{
			echo "No tiene permiso para acceder";
		}
	}
}
?>